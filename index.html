<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />

  <script></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"></script> -->
  <title>Fun Run</title>
</head>

<body>
  <canvas id="myCanvas" width="1000" height="450" style="border: 1px solid black;">
    <img src="/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/16-bit-background_5878-3.jpg"
      id="img" style="width: 100%;
                height: 100%;" />
  </canvas>

  <script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");



    // SCROLLING BACKGROUND CODE

    var img = document.getElementsByTagName("img")[0];
    var velocity = 900; //100pixels/second
    var distance = 0;
    var lastFrameRepaintTime = 0;

    function calcOffset(time) {
      var frameGapTime = time - lastFrameRepaintTime;
      lastFrameRepaintTime = time;
      var translateX = velocity * (frameGapTime / 1000); //100px per frame
      return translateX;
    }
    function draw(time) {
      distance += calcOffset(time);
      if (distance > img.width) {
        distance = 0;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(-distance, 0);
      ctx.drawImage(img, 0, 0);
      ctx.drawImage(img, img.width - 1, 0);

      requestAnimationFrame(draw);

      ctx.restore();
    }

    function start() {
      lastFrameRepaintTime = window.performance.now();
      requestAnimationFrame(draw);
    }

    //UTILITY FUNCTIONS

    function getDistance(x1, y1, x2, y2) {
      let xDistance = x2 - x1; //x distance between two points
      let yDistance = y2 - y1; //y distance between two points

      return Math.sqrt(Math.pow(xDistance, 2) + Math.pow(yDistance, 2));
    }

    //PLATFORM CODE

    function PlatformObj(x, y) {
      var platformPath =
        "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/Sprite Sheets/Platforms and Obstacles/Platform_2.png";
      var platformSprite = new Image();
      platformSprite.src = platformPath;

      platformX -= 8;
      platformXtwo -= 8;

      if (platformX < -950) {
        platformX = 1000;
        platformXtwo = 1550;
        platformY = randomNum(250, 300);
        platformYtwo = randomNum(165, 200);
      }

      this.x = x;
      this.y = y;

      this.update = () => {
        //I PROLLY DUN NEED THIS!
        this.draw();
      };
      this.draw = () => {
        ctx.beginPath();
        ctx.drawImage(platformSprite, x, y, 400, 55);
        ctx.fill();
        ctx.closePath();

      };
      this.reset = () => {
        //create a reset function! ;)
      }
    }

    let platformXtwo = 1575;
    let platformYtwo = 250;

    var platformX = 1000; //x
    var platformY = 275;

    //so i guess i can have two or three platform objects

    function drawPlatform(x, y) {
      platform1 = new PlatformObj(platformX, platformY);
      platform2 = new PlatformObj(platformXtwo, platformYtwo);


      var platformsArr = [platform1, platform2];

      platformsArr.forEach(platform => {
        platform.update();
      })

      window.requestAnimationFrame(drawPlatform);
    }


    //JUMPING RECTANGLE CODE

    rectangle = {
      height: 32,
      jumping: true,
      jumps: 0,
      width: 32,
      x: 100,
      x_velocity: 0,
      y: Object.freeze(100),
      y_velocity: 0,
    };

    //CONTROLLER OBJECT/FUNCTION

    var firing = false;

    controller = {
      up: false,
      left: false,
      down: false,
      right: false,
      fire: false,
      keyListener: function (event) {

        var key_state = event.type == "keydown" ? true : false;

        switch (event.keyCode) {
          case 38:
            controller.up = key_state;
            break;
          case 32:
            controller.fire = key_state;
            console.log('fire');
            firing = true;
            let bY = rectangle.y;
            break;
        }
      }
    };

    //BOOMERANG LOGIC


    boomerangObj = {

    }

    var boomX = 52;
    var boomerangImg = new Image;
    boomerangImg.src = "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/link-2.gif";

    let boomSpriteX = 327.5
    let boomSpriteY = 253

    let boomCounter = 0;

    let boomerangObject = {
      x: 0,
      y: 0
    }

    function handleBoomerang() {

      if (firing == true) {
        let boomY = rectangle.y;
        // boomY = this.boomY;
        let y;
        this.y = boomY;

        ctx.beginPath();
        ctx.drawImage(boomerangImg, boomSpriteX, boomSpriteY, 12, 15, rectangle.x + boomX, this.y, 30, 30);
        ctx.fill();

        boomX += 10

        if (boomCounter > 3) {
          boomCounter = 0;
          boomSpriteX += 25;
          if (boomSpriteX > 375) {
            boomSpriteX = 327.5
          }
        } else {
          boomCounter += 1;
        }
      }

      else {
        boomX = 52;
        firing = false;
        controller.fire = false;
      }

      window.requestAnimationFrame(handleBoomerang);

      if (boomX > 875) {
        firing = false;
      }

    }

    //LOOP FUNCTION (COLLISION)

    loop = function () {
      if (controller.up && rectangle.jumping == false) {
        rectangle.y_velocity -= 40;
        rectangle.jumping = true;
        rectangle.jumps += 1;
      }

      rectangle.y_velocity += 2.9; //gravity
      rectangle.y += rectangle.y_velocity;
      rectangle.y_velocity *= 0.9; //friction

      //FLOOR COLLISION
      if (rectangle.y > 300) {
        rectangle.jumping = false;
        rectangle.y = 300;
        rectangle.y_velocity = 0;
      }

      //PLATFORM COLLISION

      window.requestAnimationFrame(loop);

      if (rectangle.x >= platformX && rectangle.x < platformX + 350) {
        if (rectangle.y + 47 >= platformY && rectangle.y <= platformY - 5) {
          rectangle.y_velocity = -3;
          // rectangle.y = platformY - 38;
          rectangle.jumping = false;
        }
      }

      if (rectangle.x > platform2.x && rectangle.x < platform2.x + 350) {
        if (rectangle.y + 47 >= platform2.y && rectangle.y <= platform2.y - 5) {
          rectangle.y_velocity = -3;
          // rectangle.y = platform2.y - 38;
          rectangle.jumping = false;
        }
      }

      //TRIFORCE COLLISION



      //ENEMY COLLISION

      // if (rectangle.x >= enemyX && rectangle.x <= enemyX + 50) {
      //   if (rectangle.y + 10 >= enemyY && rectangle.y <= enemyY) {
      //     console.log('enemy hit!');
      //     gameOver = true;
      //   }
      // }

      ctx.drawImage(enemy, 160, 7, 25, 25, 1075 + enemyX, randomEnemyY + enemyY, 70, 50);

      if (rectangle.x > 1075 + enemyX && rectangle.x < 1075 + enemyX + 30) {
        if (rectangle.y + 47 >= randomEnemyY + enemyY && rectangle.y <= randomEnemyY + enemyY - 5) {
          console.log("enemy HIT!!!!");
        }
      }

    };




    // LINK SPRITE LOGIC

    let spriteX = 235;

    let spriteTime = 0;

    function drawLink() {
      var megaman =
        "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/link.png";
      var megamanSprite = new Image();
      megamanSprite.src = megaman;

      ctx.beginPath();
      ctx.drawImage(
        megamanSprite,
        spriteX,
        119,
        25,
        25,
        rectangle.x,
        rectangle.y,
        50,
        50
      );
      ctx.fill();

      if (spriteX >= 355) {
        spriteX = 235;
      } else if (spriteTime >= 10) {
        spriteX += 60;
        spriteTime = 0;
      }

      spriteTime += 1;

      window.requestAnimationFrame(drawLink);
    }


    //ENEMIES HANDLER




    let randomEnemyY = 1100;
    let enemy = new Image();
    enemy.src = "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/castlevania2_enemies_sheet.png";
    let enemyX = 0;
    let enemyY = 0;

    function randomNum(min, max) {
      return Math.random() * (max - min) + min;
    }

    let enemyFloatUp = false;

    let floatCounter = 0;

    function handleEnemy() {

      ctx.beginPath();
      ctx.drawImage(enemy, 160, 7, 25, 25, 1075 + enemyX, randomEnemyY + enemyY, 70, 50);
      ctx.fill();

      enemyX -= 16;

      if (enemyFloatUp) {
        enemyY += 1;
        floatCounter += 1;
      }

      else if (enemyFloatUp == false) {
        enemyY -= 1;
        floatCounter += 1;
      }

      if (floatCounter >= 20) {
        enemyFloatUp = !enemyFloatUp;
        floatCounter = 0;
      }


      if (enemyX < -1400) {
        enemyX = 0;
        enemyY = 0;
        randomEnemyY = randomNum(150, 300);
        floatCounter = 0;
      }

      window.requestAnimationFrame(handleEnemy);

    }

    let triforce = new Image();
    triforce.src = "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/Sprite Sheets/Items/oot_triforce_alpha.png"

    //TRIFORCE PIECES HANDLER

    let triforceX = 138.5
    let triforceCounter = 0;
    let triforcePosX = 1500;
    let triforceY = 300
    var collectCount = 0;

    let triforceCollectArray = [];

    function triforcePiece() {

      ctx.beginPath();
      ctx.drawImage(triforce, triforceX, 24.5, 15, 15, triforcePosX, triforceY, 30, 30);
      ctx.fill();

      if (rectangle.x >= triforcePosX - 10 && rectangle.x <= triforcePosX + 50) {
        if (rectangle.y >= triforceY && rectangle.y <= triforceY + 50) {
          console.log("collected!!!!");
          collectCount += 1;

          triforcePosX = 1700;
          let triforceY = 300;

        }
      }



      triforcePosX -= 16;

      if (triforceCounter > 4) {
        triforceX += 17;
        triforceCounter = 0;
      }
      triforceCounter += 1;

      if (triforceX > 250) {
        triforceX = 138.5;
      }

      if (triforcePosX < -1000) {
        triforcePosX = 1700;
      }

      window.requestAnimationFrame(triforcePiece);
    }

    let spikes = new Image();
    spikes.src = "/Users/Ronald_Crecco/Desktop/Projects Aug 2019/Fun Run JS Project/graphics/Sprite Sheets/Items/Long_Spike_Row.png";

    let spikeX = 1500;
    let spikeY = 325;

    function drawSpikes() {

      ctx.beginPath();
      ctx.drawImage(spikes, 0, 0, 609, 127, spikeX, spikeY, 200, 25);
      ctx.fill();

      spikeX -= 16;

      if (spikeX < -725) {
        spikeX = 1500;
      }

      window.requestAnimationFrame(drawSpikes)
    }


    let scoreCounter = 0;

    function scoreText() {

      ctx.font = "20px Lucida Console"
      ctx.fillStyle = "gray";
      ctx.fillText(`Score: ${scoreCounter}`, 890, 425);
      ctx.fillText(`Shards Collected: ${collectCount}`, 25, 425);

      scoreCounter += 1;

      window.requestAnimationFrame(scoreText);

    }



    let lifeCount = 100;

    function lifeCounter() {


      ctx.beginPath();
      ctx.fillText(`Life Counter: ${Math.floor(lifeCount)}%`, 400, 425)
      ctx.fill();

      // if (rectangle.x >= platformX && rectangle.x < platformX + 350) {
      //   if (rectangle.y + 47 >= platformY && rectangle.y <= platformY - 5) {
      //     rectangle.y_velocity = -3;
      //     // rectangle.y = platformY - 38;
      //     rectangle.jumping = false;
      //   }
      // }

      if (rectangle.x > spikeX && rectangle.x < spikeX + 350) {
        if (rectangle.y + 47 >= spikeY && rectangle.y <= spikeY - 5) {
          // lifeCount -= 0.35;
          lifeCount -= 10;
        }
      }

      if (rectangle.x >= enemyX && rectangle.x <= enemyX + 45) {
        if (rectangle.y >= enemyY - 15 && rectangle.y <= enemyY + 15) {
          lifeCount -= 10;
        }
      }

      if (lifeCount < 0) {
        gameOverFunction();
      }

      window.requestAnimationFrame(lifeCounter);

    }

    // TRIFORCE SOUND EFFECT


    //EVENT LISTENERS

    document.addEventListener("keydown", controller.keyListener);
    document.addEventListener("keyup", controller.keyListener);
    // document.addEventListener("mousemove", mouseMoveHandler, false);




    function gameOverFunction() {
      console.log("HEY GAME OVER!")
      window.requestAnimationFrame(gameOverFunction);
    }



    function game() {

      if (lifeCount > 0) {
        start();
        drawPlatform();
        handleBoomerang();
        drawLink();
        handleEnemy();
        drawSpikes();
        triforcePiece();
        lifeCounter();
        scoreText();
        loop();
      } else {
        gameOverFunction();
      }

    }


    game();


    //Score
    //look into using a master "draw" function

  </script>
</body>

</html>

<!-- if the sprites bottom (top left corner - height), is a the same X as the platform,
and the sprites bottom is also between the platforms top left and top right points -->